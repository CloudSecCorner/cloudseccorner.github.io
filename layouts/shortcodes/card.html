{{- $context := . -}}
{{- $link := .Get "link" -}}
{{- $title := .Get "title" -}}
{{- $icon := .Get "icon" -}}
{{- $subtitle := .Get "subtitle" -}}
{{- $image := .Get "image" -}}
{{- $width := 0 -}}
{{- $height := 0 -}}
{{- $imageStyle := .Get "imageStyle" -}}
{{- $stars := .Get "stars" -}}
{{- $isGithubRepo := .Get "isGithubRepo" -}}

{{/* Image processing options */}}
{{- $method := .Get "method" | default "Resize" | humanize -}}
{{- $options := .Get "options" | default "800x webp q80" -}}

{{- if and $image (not (urls.Parse $image).Scheme) -}}
{{/* Process images in assets */}}
{{- with resources.Get $image -}}
{{- $processed := "" -}}
{{- if eq $method "Resize" -}}
{{- $processed = (.Resize $options) -}}
{{- else if eq $method "Fit" -}}
{{- $processed = (.Fit $options) -}}
{{- else if eq $method "Fill" -}}
{{- $processed = (.Fill $options) -}}
{{- else if eq $method "Crop" -}}
{{- $processed = (.Crop $options) -}}
{{- else -}}
{{- errorf "Invalid image processing command: Must be one of Crop, Fit, Fill or Resize." -}}
{{- end -}}
{{- $width = $processed.Width -}}
{{- $height = $processed.Height -}}
{{- $image = $processed.RelPermalink -}}
{{- else -}}
{{/* Otherwise, use relative link of the image */}}
{{- if hasPrefix $image "/" -}}
{{- $image = relURL (strings.TrimPrefix "/" $image) -}}
{{- end -}}
{{- end -}}
{{- end -}}

{{- $external := strings.HasPrefix $link "http" -}}
{{- $href := cond (strings.HasPrefix $link "/") ($link | relURL) $link -}}

<div class="hextra-card group flex flex-col justify-start overflow-hidden rounded-lg border border-gray-200 text-current no-underline dark:shadow-none hover:shadow-lg dark:hover:shadow-none shadow-gray-100 active:shadow-sm active:shadow-gray-200 transition-all duration-200 bg-white">
  <a {{- if $link -}} href="{{ $href }}" {{ with $external }}target="_blank" rel="noreferrer"{{ end -}} {{- end -}} class="block">
    {{- with $image -}}
    <img alt="{{ $title }}" loading="lazy" decoding="async" src="{{ $image | safeURL }}" {{ with $width }}width="{{ . }}"{{ end }} {{ with $height }}height="{{ . }}"{{ end }} {{ with $imageStyle }}style="{{ . | safeCSS }}"{{ end }} class="w-full object-cover h-48" />
    {{- end -}}

    <div class="p-4">
      <span class="flex font-semibold items-center gap-2 text-gray-700 hover:text-gray-900 dark:text-neutral-200 dark:hover:text-neutral-50">
        {{- with $icon }}{{ partial "utils/icon.html" (dict "name" $icon) -}}{{- end -}}
        {{- $title -}}
      </span>
      {{- with $subtitle -}}
      <div class="line-clamp-3 text-sm font-normal text-gray-500 dark:text-gray-400 mt-2">{{- $subtitle | markdownify -}}</div>
      {{- end -}}
    </div>
  </a>
  {{- if $isGithubRepo -}}
  <div class="flex items-center justify-between px-4 py-3 border-t border-gray-200 dark:border-neutral-700">
    <div class="flex items-center">
      <svg class="h-4 w-4 text-gray-500 mr-1" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
      </svg>
      <span class="text-sm text-gray-500">{{ $stars }}</span>
    </div>
    <a href="{{ $link }}" target="_blank" rel="noopener noreferrer" class="github-star-button inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
      <svg class="h-4 w-4 text-gray-500 mr-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
        <path d="M10 3.172l1.527 3.094 3.45.317L14.5 8.47l1.157 3.238-3.093-1.738L10 11.567l-1.564 2.343-3.093 1.738L5.5 8.47l-2.477-1.887 3.45-.317L10 3.172z" />
      </svg>
      <span>Star</span>
    </a>
    <a href="{{ $link }}" target="_blank" rel="noopener noreferrer" class="github-star-button inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <svg class="h-4 w-4 text-gray-500 mr-1" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.68-.22.68-.48 0-.24-.01-.87-.01-1.7 0 0-2.78.58-3.37-1.38 0 0-.46-.96-1.14-1.22 0 0-.94-.01-.01-.01.88 0 1.6 1.02 1.6 1.02.94 1.58 2.44 1.1 3.03.84 0 0 .01-.65.01-1.18-2.33-.26-4.76-1.17-4.76-5.22 0-1.15.4-2.09 1.05-2.84-.11-.26-.46-1.34.1-2.79 0 0 .86-.28 2.81 1.07.82-.23 1.7-.34 2.58-.34.88 0 1.76.11 2.58.34 1.95-1.35 2.81-1.07 2.81-1.07.56 1.45.21 2.53.1 2.79.65.75 1.05 1.69 1.05 2.84 0 4.07-2.43 4.96-4.77 5.22.37.32.68.94.68 1.9 0 1.37-.01 2.48-.01 2.82 0 .26.18.56.68.48C19.13 20.17 22 16.42 22 12c0-5.523-4.477-10-10-10z" />
        </svg>
        <span>Github</span>
      </a>
  </div>
  {{- end -}}
</div>
