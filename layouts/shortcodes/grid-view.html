{{- $githubApiBase := "https://api.github.com/repos/" -}}
{{- $cardsPerRow := .Get "cardsPerRow" | default 3 -}} {{/* Get the desired number of cards per row from shortcode parameters, default to 3 */}}
{{- $cardsPerRowClass := "" -}}

{{- if eq $cardsPerRow 1 -}}
  {{- $cardsPerRowClass = "grid-cols-1" -}}
{{- else if eq $cardsPerRow 2 -}}
  {{- $cardsPerRowClass = "grid-cols-1 md:grid-cols-2" -}}
{{- else if eq $cardsPerRow 3 -}}
  {{- $cardsPerRowClass = "grid-cols-1 md:grid-cols-2 lg:grid-cols-3" -}}
{{- else if eq $cardsPerRow 4 -}}
  {{- $cardsPerRowClass = "grid-cols-1 md:grid-cols-2 lg:grid-cols-4" -}}
{{- else if eq $cardsPerRow 5 -}}
  {{- $cardsPerRowClass = "grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5" -}}
{{- else -}}
  {{- $cardsPerRowClass = "grid-cols-1 md:grid-cols-2 lg:grid-cols-3" -}} {{/* Default to 3 if an invalid number is provided */}}
{{- end -}}

<div class="mb-8">
  <input type="text" id="categorySearch" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Search by category or tool name...">
</div>
<div id="categoryGrid">
  {{- range $index, $categoryData := .Site.Data.tools }}
  <h2 class="text-2xl font-bold mt-8 mb-4 category-title">{{ $categoryData.category }}</h2>
  <div class="grid {{ $cardsPerRowClass }} gap-6 category-grid">
    {{ range $index, $tool := $categoryData.tools }}
    {{- $isGithubRepo := false -}}
    {{- $stars := 0 -}}
    {{- $repoPath := "" -}}

    {{- if strings.Contains $tool.url "github.com" -}}
    {{- $isGithubRepo = true -}}
    {{- $repoPath = replace $tool.url "https://github.com/" "" -}}
    {{- if strings.Contains $repoPath "/" -}}
    {{- $apiURL := printf "%s%s" $githubApiBase $repoPath -}}
    {{- $tryResponse := try (resources.GetRemote $apiURL) -}}
    {{- if $tryResponse -}}
    {{- $response := $tryResponse.Value -}}
    {{- if eq $response.MediaType.SubType "json" -}}
    {{- $jsonData := $response | transform.Unmarshal -}}
    {{- $stars = $jsonData.stargazers_count -}}
    {{- end -}}
    {{- end -}}
    {{- else -}}
    {{- $isGithubRepo = false -}}
    {{- end -}}
    {{- end -}}

    {{- $cardParams := dict "link" $tool.url "title" $tool.name "subtitle" $tool.description "isGithubRepo" $isGithubRepo "stars" $stars -}}
    {{- partial "shortcodes/card.html" $cardParams -}}
    {{ end }}
  </div>
  {{ end }}
</div>
<script>
  const searchInput = document.getElementById('categorySearch');
  const categoryTitles = document.querySelectorAll('.category-title');
  const categoryGrids = document.querySelectorAll('.category-grid');
  const cards = document.querySelectorAll('.hextra-card');

  searchInput.addEventListener('input', () => {
    const searchTerm = searchInput.value.toLowerCase();

    categoryTitles.forEach((title, index) => {
      const categoryName = title.textContent.toLowerCase();
      const grid = categoryGrids[index];
      let categoryVisible = false;

      // Check if the category name matches the search term
      if (categoryName.includes(searchTerm)) {
        categoryVisible = true;
      }

      // Check if any card in the category matches the search term
      const categoryCards = grid.querySelectorAll('.hextra-card');
      categoryCards.forEach(card => {
        const cardTitle = card.querySelector('.font-semibold').textContent.toLowerCase();
        if (cardTitle.includes(searchTerm)) {
          categoryVisible = true;
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });

      // Show/hide the category based on visibility
      if (categoryVisible) {
        title.style.display = 'block';
        grid.style.display = 'grid';
      } else {
        title.style.display = 'none';
        grid.style.display = 'none';
      }
    });
  });
</script>
